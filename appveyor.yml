version: '1.0.{build}'

image: Visual Studio 2017

configuration:
- Release

platform: Any CPU

environment:
  DOTNET_CLI_TELEMETRY_OPTOUT: 1

init:
- cmd: git config --global core.autocrlf true
- ps: $Env:LABEL = "preview1-" + $Env:APPVEYOR_BUILD_NUMBER.PadLeft(5, "0")
- ps: if(-not $env:APPVEYOR_PULL_REQUEST_NUMBER) { $env:is_not_pr = "true"; }

dotnet_csproj:
  patch: true
  file: '**\*.csproj'
  version: '%LABEL%'
  package_version: '%LABEL%'

before_build:
- appveyor-retry dotnet restore -v Minimal

build:
 project: SourceCode.Chasm.sln
 verbosity: minimal

test_script:
- ps1: .\GenerateTestSolution.ps1 .\SourceCode.Chasm.sln
- dotnet test "src\SourceCode.Chasm.Tests.sln" -c %CONFIGURATION% --no-build

artifacts:
  - path: '**\*.nupkg'

deploy:
  provider: NuGet
  api_key:
    secure: JlUgeUsCDsMvMo4u5DwopSnGM4+FByY6kc0WQw841Bt0BX7ntT09kiH2R6ybWAOO
  on:
    branch: master
    is_not_pr: true
